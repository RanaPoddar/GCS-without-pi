<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team PUSHPAK Mission Control</title>
    
    <!-- Leaflet for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Draw for polygons -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- JSZip for KML parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- toGeoJSON for KML to GeoJSON -->
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.2/togeojson.js"></script>
    
    <link rel="stylesheet" href="mission_control.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <h1 class="logo">
                    <span class="logo-icon"></span>
                    Team PUSHPAK Mission Control
                </h1>
            </div>
            <div class="header-center">
                <div class="mission-status" id="missionStatus">
                    <span class="status-indicator status-idle"></span>
                    <span class="status-text">IDLE</span>
                </div>
            </div>
            <div class="header-right">
                <div class="drone-connections">
                    <div class="drone-connection-item">
                        <span class="drone-label">Drone 1</span>
                        <span class="drone-status-indicator" id="drone1StatusIndicator">‚óè</span>
                        <span class="drone-status-text" id="drone1StatusText">Disconnected</span>
                        <button class="reconnect-btn" id="reconnectDrone1" title="Reconnect Drone 1">‚ü≤</button>
                        <button class="simulate-btn" id="simulateDrone1" title="Test Mode (No Hardware)">üéÆ</button>
                    </div>
                    <div class="drone-connection-item">
                        <span class="drone-label">Drone 2</span>
                        <span class="drone-status-indicator" id="drone2StatusIndicator">‚óè</span>
                        <span class="drone-status-text" id="drone2StatusText">Disconnected</span>
                        <button class="reconnect-btn" id="reconnectDrone2" title="Reconnect Drone 2">‚ü≤</button>
                        <button class="simulate-btn" id="simulateDrone2" title="Test Mode (No Hardware)">üéÆ</button>
                    </div>
                </div>
                <div class="connection-status" id="connectionStatus">
                    <span class="connection-indicator offline"></span>
                    <span>Server: Disconnected</span>
                </div>
            </div>
        </header>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Left Panel: Mission Setup & Control -->
            <aside class="left-panel">
                <!-- Mission Upload Section -->
                <div class="panel-section">
                    <h3 class="section-title">
                        <span class="section-icon">üìÇ</span>
                        Mission Planning
                    </h3>
                    
                    <div class="upload-zone" id="uploadZone">
                        <input type="file" id="kmlFileInput" accept=".kml,.kmz" style="display: none;">
                        <div class="upload-content">
                            <div class="upload-icon">üì§</div>
                            <p class="upload-text">Drop KML/KMZ file here</p>
                            <p class="upload-subtext">or click to browse</p>
                        </div>
                    </div>
                    
                    <div class="upload-divider">
                        <span>OR</span>
                    </div>
                    
                    <div class="waypoints-upload-zone">
                        <input type="file" id="waypointsFileInput" accept=".waypoints" style="display: none;">
                        <button class="btn btn-secondary" id="uploadWaypointsBtn">
                            <span class="btn-icon">üìÑ</span>
                            Upload .waypoints File
                        </button>
                        <p class="upload-hint">Upload Mission Planner .waypoints file directly</p>
                    </div>
                    
                    <div id="missionInfo" class="mission-info hidden">
                        <div class="info-item">
                            <span class="info-label">File:</span>
                            <span class="info-value" id="fileName">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Waypoints:</span>
                            <span class="info-value" id="waypointCount">0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Area:</span>
                            <span class="info-value" id="missionArea">0 ha</span>
                        </div>
                    </div>
                </div>

                <!-- Mission Parameters -->
                <div class="panel-section">
                    <h3 class="section-title">
                        <span class="section-icon">‚öôÔ∏è</span>
                        Parameters
                    </h3>
                    
                    <div class="parameter-grid">
                        <div class="param-group">
                            <label>Altitude (m)</label>
                            <input type="number" id="altitude" value="15" min="10" max="200" step="1">
                        </div>
                        
                        <div class="param-group">
                            <label>Speed (m/s)</label>
                            <input type="number" id="speed" value="2" min="1" max="15" step="0.5">
                        </div>
                        
                        <div class="param-group">
                            <label>Overlap (%)</label>
                            <input type="number" id="overlap" value="70" min="50" max="90" step="5">
                        </div>
                        
                        <div class="param-group">
                            <label>Grid Angle (¬∞)</label>
                            <input type="number" id="gridAngle" value="0" min="0" max="180" step="5">
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" id="generateGrid">
                        <span class="btn-icon">üî≤</span>
                        Generate Survey Grid
                    </button>
                </div>

                <!-- Mission Control Actions -->
                <div class="panel-section">
                    <h3 class="section-title">
                        <span class="section-icon">üéÆ</span>
                        Mission Control
                    </h3>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="startMission" disabled>
                            <span class="btn-icon">‚ñ∂Ô∏è</span>
                            Start Mission
                        </button>
                        
                        <button class="btn btn-warning" id="pauseMission" disabled>
                            <span class="btn-icon">‚è∏Ô∏è</span>
                            Pause
                        </button>
                        
                        <button class="btn btn-danger" id="stopMission" disabled>
                            <span class="btn-icon">‚èπÔ∏è</span>
                            Stop
                        </button>
                        
                        <button class="btn btn-secondary" id="returnToHome" disabled>
                            <span class="btn-icon">üè†</span>
                            Return to Home
                        </button>
                    </div>
                </div>

                <!-- Detection Control -->
                <div class="panel-section">
                    <h3 class="section-title">
                        <span class="section-icon">üåæ</span>
                        Crop Detection
                    </h3>
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" id="startDetection1" disabled>
                            <span class="btn-icon">‚ñ∂Ô∏è</span>
                            Start Detection (D1)
                        </button>
                        
                        <button class="btn btn-warning" id="stopDetection1" disabled>
                            <span class="btn-icon">‚èπÔ∏è</span>
                            Stop Detection (D1)
                        </button>
                        
                        <button class="btn btn-success" id="startDetection2" disabled>
                            <span class="btn-icon">‚ñ∂Ô∏è</span>
                            Start Detection (D2)
                        </button>
                        
                        <button class="btn btn-warning" id="stopDetection2" disabled>
                            <span class="btn-icon">‚èπÔ∏è</span>
                            Stop Detection (D2)
                        </button>
                    </div>
                    
                    <div class="info-item" style="margin-top: 10px;">
                        <span class="info-label">D1 Status:</span>
                        <span class="info-value" id="detection1Status">Inactive</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">D2 Status:</span>
                        <span class="info-value" id="detection2Status">Inactive</span>
                    </div>
                </div>

                <!-- Mission Progress -->
                <div class="panel-section">
                    <h3 class="section-title">
                        <span class="section-icon">üìä</span>
                        Progress
                    </h3>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-stats">
                            <div class="stat-item">
                                <span class="stat-label">Complete:</span>
                                <span class="stat-value" id="progressPercent">0%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Est. Time:</span>
                                <span class="stat-value" id="estTime">--:--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Elapsed:</span>
                                <span class="stat-value" id="elapsedTime">00:00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Messages Console -->
                <div class="panel-section">
                    <h3 class="section-title">
                        <span class="section-icon">üí¨</span>
                        System Messages
                        <button class="clear-console-btn" id="clearConsole" title="Clear messages">üóëÔ∏è</button>
                    </h3>
                    <div class="system-console" id="systemConsole">
                        <div class="console-message console-info">
                            <span class="console-time">00:00:00</span>
                            <span class="console-text">System initialized</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Center Panel: Map View -->
            <main class="center-panel">
                <div class="map-container">
                    <div id="map"></div>
                    
                    <!-- Map Controls Overlay -->
                    <div class="map-controls">
                        <button class="map-btn" id="centerMap" title="Center on Drones">
                            <span>üéØ</span>
                        </button>
                        <button class="map-btn" id="toggleLayers" title="Toggle Layers">
                            <span>üó∫Ô∏è</span>
                        </button>
                        <button class="map-btn" id="clearMission" title="Clear Mission">
                            <span>üóëÔ∏è</span>
                        </button>
                    </div>
                    
                    <!-- Layer Control Panel -->
                    <div class="layer-panel hidden" id="layerPanel">
                        <h4>Map Layers</h4>
                        <label class="layer-option">
                            <input type="checkbox" id="showBoundary" checked>
                            <span>Mission Boundary</span>
                        </label>
                        <label class="layer-option">
                            <input type="checkbox" id="showGrid" checked>
                            <span>Survey Grid</span>
                        </label>
                        <label class="layer-option">
                            <input type="checkbox" id="showDronePaths" checked>
                            <span>Drone Paths</span>
                        </label>
                        <label class="layer-option">
                            <input type="checkbox" id="showDetections">
                            <span>Detections</span>
                        </label>
                    </div>
                </div>
            </main>

            <!-- Right Panel: Drone Status -->
            <aside class="right-panel">
                <!-- Drone 1 Status -->
                <div class="panel-section drone-panel" id="drone1Panel">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <img src="assets/scanning_drone.png" alt="Scanning Drone" style="width: 60px; height: 60px; object-fit: contain;">
                        <div style="flex: 1;">
                            <h3 class="section-title drone-title" style="margin: 0;">
                                Drone 1 (Scanning)
                                <span class="drone-badge badge-offline" id="drone1Status">OFFLINE</span>
                            </h3>
                        </div>
                    </div>
                    <div style="text-align: center; margin-bottom: 10px;">
                        <span class="drone-badge badge-offline" id="drone1Armed">DISARMED</span>
                    </div>
                    
                    <!-- HUD Status Display -->
                    <div class="hud-status">
                        <div class="hud-row">
                            <span class="hud-label">ALT</span>
                            <span class="hud-value" id="drone1AltHud">--</span>
                        </div>
                        <div class="hud-row">
                            <span class="hud-label">SPD</span>
                            <span class="hud-value" id="drone1SpdHud">--</span>
                        </div>
                        <div class="hud-row">
                            <span class="hud-label">BAT</span>
                            <span class="hud-value" id="drone1BatHud">--%</span>
                        </div>
                        <div class="hud-row">
                            <span class="hud-label">VOLT</span>
                            <span class="hud-value" id="drone1VoltHud">--V</span>
                        </div>
                    </div>
                    
                    <div class="telemetry-grid">
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üìç</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">LAT</span>
                                <span class="telemetry-value" id="drone1Lat">--</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üìç</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">LON</span>
                                <span class="telemetry-value" id="drone1Lon">--</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">‚¨ÜÔ∏è</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">ALT</span>
                                <span class="telemetry-value" id="drone1Alt">--</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üß≠</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">HDG</span>
                                <span class="telemetry-value" id="drone1Heading">--</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">‚ö°</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">SPD</span>
                                <span class="telemetry-value" id="drone1Speed">--</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üì°</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">GPS</span>
                                <span class="telemetry-value" id="drone1Gps">No Fix</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üõ∞Ô∏è</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">MODE</span>
                                <span class="telemetry-value" id="drone1Mode">STANDBY</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üéØ</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">DET</span>
                                <span class="telemetry-value" id="drone1Detections">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Battery Bar -->
                    <div class="battery-container">
                        <span class="battery-label">Battery</span>
                        <div class="battery-indicator">
                            <div class="battery-fill" id="drone1Battery" style="width: 0%"></div>
                        </div>
                        <span class="battery-text" id="drone1BatteryText">--%</span>
                    </div>
                </div>

                <!-- Drone 2 Status -->
                <div class="panel-section drone-panel" id="drone2Panel">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <img src="assets/spray_drone.png" alt="Spray Drone" style="width: 60px; height: 60px; object-fit: contain;">
                        <div style="flex: 1;">
                            <h3 class="section-title drone-title" style="margin: 0;">
                                Drone 2 (Spraying)
                                <span class="drone-badge badge-offline" id="drone2Status">OFFLINE</span>
                            </h3>
                        </div>
                    </div>
                    <div style="text-align: center; margin-bottom: 10px;">
                        <span class="drone-badge badge-offline" id="drone2Armed">DISARMED</span>
                    </div>
                    
                    <!-- HUD Status Display -->
                    <div class="hud-status">
                        <div class="hud-row">
                            <span class="hud-label">ALT</span>
                            <span class="hud-value" id="drone2AltHud">--</span>
                        </div>
                        <div class="hud-row">
                            <span class="hud-label">SPD</span>
                            <span class="hud-value" id="drone2SpdHud">--</span>
                        </div>
                        <div class="hud-row">
                            <span class="hud-label">BAT</span>
                            <span class="hud-value" id="drone2BatHud">--%</span>
                        </div>
                        <div class="hud-row">
                            <span class="hud-label">VOLT</span>
                            <span class="hud-value" id="drone2VoltHud">--V</span>
                        </div>
                    </div>
                    
                    <div class="telemetry-grid">
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üìç</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">LAT</span>
                                <span class="telemetry-value" id="drone2Lat">--</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üìç</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">LON</span>
                                <span class="telemetry-value" id="drone2Lon">--</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">‚¨ÜÔ∏è</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">ALT</span>
                                <span class="telemetry-value" id="drone2Alt">--</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üß≠</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">HDG</span>
                                <span class="telemetry-value" id="drone2Heading">--</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">‚ö°</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">SPD</span>
                                <span class="telemetry-value" id="drone2Speed">--</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üì°</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">GPS</span>
                                <span class="telemetry-value" id="drone2Gps">No Fix</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üõ∞Ô∏è</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">MODE</span>
                                <span class="telemetry-value" id="drone2Mode">STANDBY</span>
                            </div>
                        </div>
                        
                        <div class="telemetry-item">
                            <div class="telemetry-icon">üéØ</div>
                            <div class="telemetry-data">
                                <span class="telemetry-label">DET</span>
                                <span class="telemetry-value" id="drone2Detections">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Battery Bar -->
                    <div class="battery-container">
                        <span class="battery-label">Battery</span>
                        <div class="battery-indicator">
                            <div class="battery-fill" id="drone2Battery" style="width: 0%"></div>
                        </div>
                        <span class="battery-text" id="drone2BatteryText">--%</span>
                    </div>
                </div>

                <!-- System Alerts -->
                <div class="panel-section">
                    <h3 class="section-title">
                        <span class="section-icon">‚ö†Ô∏è</span>
                        Alerts
                    </h3>
                    <div class="alerts-container" id="alertsContainer">
                        <div class="alert-item alert-info">
                            <span class="alert-icon">‚ÑπÔ∏è</span>
                            <span class="alert-text">System ready</span>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Bottom Panel: Testing & Detection Log -->
        <div class="bottom-panel" id="bottomPanel">
            <div class="bottom-panel-header" id="bottomPanelHeader">
                <div class="bottom-panel-title">
                    <span class="section-icon">üß™</span>
                    Testing & Detection Log
                </div>
                <button class="bottom-panel-toggle" id="bottomPanelToggle">
                    <span id="toggleIcon">‚ñº</span>
                </button>
            </div>
            
            <div class="bottom-panel-content" id="bottomPanelContent">
                <div class="bottom-panel-grid">
                    <!-- Manual Detection Testing -->
                    <div class="bottom-panel-section">
                        <h4 class="bottom-section-title">
                            <span>üéØ</span>
                            Manual Detection Trigger
                        </h4>
                        <p class="bottom-section-description">
                            Simulate crop detection for testing. Click button while drone is flying to send current coordinates.
                        </p>
                        
                        <div class="detection-trigger-controls">
                            <div class="trigger-drone-select">
                                <label>Select Drone:</label>
                                <div class="drone-radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="triggerDrone" value="1" checked>
                                        <span>Drone 1 (Scanning)</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="triggerDrone" value="2">
                                        <span>Drone 2 (Spraying)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="trigger-confidence">
                                <label>Confidence Level:</label>
                                <div class="confidence-control">
                                    <input type="range" id="detectionConfidence" min="0" max="100" value="85" step="5">
                                    <span class="confidence-value" id="confidenceValue">85%</span>
                                </div>
                            </div>
                            
                            <button class="btn btn-success btn-trigger" id="triggerDetection">
                                <span class="btn-icon">üéØ</span>
                                Trigger Detection
                            </button>
                            
                            <div class="trigger-info" id="triggerInfo">
                                <span class="info-icon">‚ÑπÔ∏è</span>
                                <span class="info-text">Drone must be flying to trigger detection</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detection Log -->
                    <div class="bottom-panel-section detection-log-section">
                        <div class="log-header">
                            <h4 class="bottom-section-title">
                                <span>üìã</span>
                                Detection Log
                            </h4>
                            <div class="log-controls">
                                <span class="detection-count">Total: <strong id="totalDetections">0</strong></span>
                                <button class="btn-small btn-secondary" id="clearLog">Clear</button>
                                <button class="btn-small btn-secondary" id="exportLog">Export</button>
                            </div>
                        </div>
                        
                        <div class="detection-log-container" id="detectionLogContainer">
                            <div class="log-empty" id="logEmpty">
                                <span class="empty-icon">üì≠</span>
                                <p>No detections yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="mission_control.js"></script>
</body>
</html>
